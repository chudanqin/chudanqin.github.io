<!DOCTYPE html>
<html lang="en">

<!-- layout.ejs-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A website for A-RSnippet Hexo Theme">
    <meta name="author" content="Unnamed">
    <meta name="keyword" content="hexo, hexo theme, A-RSnippet, responsive, bootstrap">
    <link rel="canonical" href="http://yoursite.com/WhatDidiOSDoBeforeMain/">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="九指扣将 &lt;a class=&#34;github-button&#34; href=&#34;https://github.com/huyingjie/hexo-theme-A-RSnippet&#34; data-icon=&#34;octicon-star&#34; data-show-count=&#34;true&#34; aria-label=&#34;Star huyingjie/hexo-theme-A-RSnippet on GitHub&#34;&gt;Star&lt;/a&gt;" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <title>
        
        What did iOS do before main｜An A-RSnippet Hexo Theme
        
    </title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="/css/main.css">

    
      <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
      <link rel="stylesheet" href="/css/highlight.css">
    

    
      <script id="dsq-count-scr" src="//hexo-a-rsnippet.disqus.com/count.js" async></script>
    


    
      <meta name="google-site-verification" content="wtCjI-zcpr2FYwWS3sI4OWzMK9e7VomDrZyxpVUUIng" />
    

    

    


    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-38355881-1', 'auto');
    ga('send', 'pageview');
</script>





    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- user customization -->
    <link rel="stylesheet" href="/css/arsnippet.css">
    <script src="/js/arsnippet.css.js"></script>
</head>

<style>
    header.intro-header {
        background-image: url('')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<header>
  <nav class="navbar navbar-default header-navbar" id="nav-top" data-ispost = "true" data-istags="false" data-ishome = "false" >
    <div class="container-fluid">
      <div class="navbar-header page-scroll">
        <button type="button" class="navbar-toggle" data-toggle="collapse" aria-expanded="false"  data-target="#website_navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand animated pulse">
          <a class="brand-logo" href="/">
            九指扣将 <a class="github-button" href="https://github.com/huyingjie/hexo-theme-A-RSnippet" data-icon="octicon-star" data-show-count="true" aria-label="Star huyingjie/hexo-theme-A-RSnippet on GitHub">Star</a>
          </a>
        </span>
      </div>

      <div class="collapse navbar-collapse" id="website_navbar">
          <ul class="nav navbar-nav navbar-right">
              
                <li>
                  <a href="/">home</a>
                </li>
              
                <li>
                  <a href="/tags/">tags</a>
                </li>
              
          </ul>
      </div>
  </nav>


  
    <style>
       .intro-header {
          background-image: url('/img/sky-clouds-moon-horizon.jpg?h=350&amp;auto=compress&amp;cs=tinysrgb');
      }
    </style>

    <div class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                    <div class="site-heading">
                        <h1>What did iOS do before main</h1>
                        
                        
                          <span class="meta">
                               <span class="meta-item">Author: Unnamed</span>
                               <span class="meta-item">Date: Feb 4, 2018</span>
                               
                                 <span class="meta-item">Updated On: Feb 8, 2018</span>
                               
                          </span>
                          <div class="tags text-center">
                              Categories: 
                          </div>
                          <div class="tags text-center">
                              Tags: 
                          </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
  
</header>


<!-- Main Content -->
<!-- post.ejs -->
<article>
    <div class="container">
      <div class="col-lg-8 col-lg-offset-1 col-sm-9">
          
            <div class="text-center"><div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5272bc2a7b3c1ddc" async = "async" ></script>
</div>
</div><hr>
          
          <div class="subscribe"><a href="http://eepurl.com/dh6iCD" target="_blank">Get Updated for Each Release!</a></div><p>
          <h1 id="What-did-iOS-do-before-main"><a href="#What-did-iOS-do-before-main" class="headerlink" title="What did iOS do before main"></a>What did iOS do before main</h1><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul>
<li><p>系统先读取App的可执行文件(Mach-O文件)，从里面获得dyld的路径，然后加载dyld,dyld去初始化运行环境。</p>
</li>
<li><p>开启缓存策略，加载程序相关依赖库(其中也包含我们的可执行文件)，并对这些库进行链接，最后调用每个依赖库的初始化方法，在这一步，runtime被初始化。</p>
</li>
<li><p>当所有依赖库的初始化后，轮到最后一位(程序可执行文件)进行初始化，在这时runtime会对项目中所有类进行类机构初始化，然后调用所有的load方法。最后dyld返回main函数地址，main函数被调用，我们便来到程序入口main函数。</p>
</li>
</ul>
<h2 id="load"><a href="#load" class="headerlink" title="+ load"></a>+ load</h2><p>Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</p>
<p>The load message is sent to classes and categories that are both dynamically loaded and statically linked, but only if the newly loaded class or category implements a method that can respond.</p>
<p>The order of initialization is as follows:</p>
<p>All initializers in any framework you link to.</p>
<p>All +load methods in your image.</p>
<p>All C++ static initializers and C/C++ <strong>attribute</strong>(constructor) functions in your image.</p>
<p>All initializers in frameworks that link to you.</p>
<p>In addition:</p>
<p>A class’s +load method is called after all of its superclasses’ +load methods.</p>
<p>A category +load method is called after the class’s own +load method.</p>
<p>In a custom implementation of load you can therefore safely message other unrelated classes from the same image, but any load methods implemented by those classes may not have run yet.</p>
<ul>
<li><p>只要被打包进应用，那么无论有没有引用到（#import），load 都会被调到。</p>
</li>
<li><p>不需要调用 super。</p>
</li>
<li><p><strong>attribute</strong>(constructor) 在 load 之后，可以指定一个优先级参数（小的优先级高，101 &gt; 102）</p>
<p>c<br><strong>attribute</strong>((constructor(101))) static void constructor1() </p>
</li>
</ul>
<h2 id="initialize"><a href="#initialize" class="headerlink" title="+ initialize"></a>+ initialize</h2><p>Initializes the class before it receives its first message.</p>
<p>The runtime sends initialize to each class in a program just before the class, or any class that inherits from it, is sent its first message from within the program. Superclasses receive this message before their subclasses.</p>
<p>The runtime sends the initialize message to classes in a thread-safe manner. That is, initialize is run by the first thread to send a message to a class, and any other thread that tries to send a message to that class will block until initialize completes.</p>
<p>The superclass implementation may be called multiple times if subclasses do not implement initialize—the runtime will call the inherited implementation—or if subclasses explicitly call [super initialize]. If you want to protect yourself from being run multiple times, you can structure your implementation along these lines:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span> == [ClassName <span class="keyword">self</span>]) &#123;</span><br><span class="line">    <span class="comment">// ... do the initialization ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">+load</th>
<th style="text-align:center">+initialize</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">调用时机</td>
<td style="text-align:center">被添加到 runtime 时</td>
<td style="text-align:center">收到第一条消息前，可能永远不调用</td>
</tr>
<tr>
<td style="text-align:center">调用顺序</td>
<td style="text-align:center">父类-&gt;子类-&gt;分类</td>
<td style="text-align:center">父类-&gt;子类</td>
</tr>
<tr>
<td style="text-align:center">调用次数</td>
<td style="text-align:center">1次</td>
<td style="text-align:center">多次</td>
</tr>
<tr>
<td style="text-align:center">是否需要显式调用父类实现</td>
<td style="text-align:center">否</td>
<td style="text-align:center">否</td>
</tr>
<tr>
<td style="text-align:center">是否沿用父类的实现</td>
<td style="text-align:center">否</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">分类中的实现</td>
<td style="text-align:center">类和分类都执行</td>
<td style="text-align:center">覆盖类中的方法，只执行分类的实现</td>
</tr>
</tbody>
</table>
<p><strong>一个类的 load 并非总是比 initialize 先调用到，因为在 load 前，整个Framework已被初始化</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SuperClass</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">@implemention</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123; </span><br><span class="line">    <span class="comment">// 0</span></span><br><span class="line">    [SubClass new];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SubClass</span> : <span class="title">SuperClass</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SubClass</span> </span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h2><ul>
<li><p>Bootstraps itself based on the very simple raw stack set up for the process by the kernel.</p>
</li>
<li><p>Recursively and cachingly loads all dependent dynamic libraries the executable links to into the process’ memory space, including any necessary perusal of search paths from both the environment and the executable’s “runpaths”.</p>
</li>
<li><p>Links those libraries into the executable by immediately binding non-lazy symbols and setting up the necessary tables for lazy binding.</p>
</li>
<li><p>Runs static initializers for the executable.</p>
</li>
<li><p>Sets up the parameters to the executable’s main function and calls it.</p>
</li>
<li><p>During the process’ execution, handles calls to lazily-bound symbol stubs by binding the symbols, provides runtime dynamic loading services (via the dl*() API), and provides hooks for gdb and other debuggers to get critical information.</p>
</li>
<li><p>Runs static terminator routines after main returns.</p>
</li>
<li><p>In some scenarios, makes the required call to libSystem’s _exit routine once main returns.</p>
</li>
</ul>
<h2 id="动态链接库，需设置-Runpath"><a href="#动态链接库，需设置-Runpath" class="headerlink" title="动态链接库，需设置 Runpath"></a>动态链接库，需设置 Runpath</h2><ul>
<li>@executable_path：应用安装的绝对路径。</li>
<li>@load_path：Binary 的相对路径。</li>
<li>@rpath：类似于UNIX中的$PATH</li>
</ul>
<h3 id="executable-path，指向应用安装位置。"><a href="#executable-path，指向应用安装位置。" class="headerlink" title="@executable_path，指向应用安装位置。"></a>@executable_path，指向应用安装位置。</h3><p>如果想要将库 Foo.framework 打包到应用中，则可以使用 @executable_path。<br>例如，应用的路径为 /Applications/Bar.app/。<br>在 Mac OS 上，@executable_path 会被展开为 /Applications/Bar.app/Contents/MacOS；如果想把 Foo.framework 内置到 Contents/Frameworks，那么 Foo.framework 的 Runpath 设置为 @executable_path/../Frameworks/Foo.framework/Versions/A/Foo，动态连接器最终会到 /Applications/Bar.app/Contents/MacOS/../Frameworks/Foo.framework/Versions/A/Foo 这个路径下找到库。<br>在 iOS 上，@executable_path 会被展开为 /Applications/Bar.app/。<br>在Xcode设置 Runpath 为 @executable_path/Frameworks：</p>
<img src="/WhatDidiOSDoBeforeMain/0.png">
<h3 id="loader-path，指向-Binary（Apps，Plugins-Framworks-Dylibs-的位置。"><a href="#loader-path，指向-Binary（Apps，Plugins-Framworks-Dylibs-的位置。" class="headerlink" title="@loader_path，指向 Binary（Apps，Plugins, Framworks, Dylibs) 的位置。"></a>@loader_path，指向 Binary（Apps，Plugins, Framworks, Dylibs) 的位置。</h3><p>在应用的安装目录 Frameworks 下，如果 Foo.framework 依赖 Bar.framework，那么 @executable_path 并不能满足这种情况。可以设置 Bar.framework 的 Runpath 为 @load_path/../Frameworks。这样，无论 Frameworks 目录在哪，两个库的依赖关系都能保证。</p>
<h3 id="rpath"><a href="#rpath" class="headerlink" title="@rpath"></a>@rpath</h3><p>@rpath 和前面两个不同，它只是一个保存着一个或多个路径的变量。比如 XPSSO.dylib 被两个应用使用，且被包含的路径不同。比如：<br>softA.app/Contents/MacOS/dylib/XPSSO.dylib<br>softB.app/Contents/MacOS/Frameworks/XPSSO.dylib<br>将 XPSSO.dylib 的 INSTALL_PATH 设置成 @loader_path/../dylib 或 @loader_path/../Frameworks 都只能满足其中一个应用的需求。要解决这个问题，就可以用 @rpath 将 XPSSO.dylib 的 INSTALL_PATH 设置成 @rpath，然后在编译 softA.app，softB.app 时分别指定 @rpath 为 @loader_path/../dylib、@loader_path/../Frameworks，问题得到了解决。@rpath 的另一个优点是可以设置多个路径。如果 softA.app 还需要使用另一个 .plugin（假设它的 INSTALL_PATH 也设置成了 @rpath），位于 @loader_path/../plugin，把这个路径加到 @rpath 即可。 </p>
<img src="/WhatDidiOSDoBeforeMain/1.jpg">
<img src="/WhatDidiOSDoBeforeMain/2.jpg">
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.mikeash.com/pyblog/friday-qa-2009-11-06-linking-and-install-names.html" target="_blank" rel="noopener">https://www.mikeash.com/pyblog/friday-qa-2009-11-06-linking-and-install-names.html</a><br><a href="http://www.tanhao.me/pieces/1361.html" target="_blank" rel="noopener">http://www.tanhao.me/pieces/1361.html</a></p>

          
          <hr>
          <ul class="pager">
              
              <li class="previous">
                  <a href="/OSAtomic/" data-toggle="tooltip" data-placement="left"
                     title="OSAtomic">&larr; Previous Post</a>
              </li>
              
              
              <li class="next">
                  <a href="/CreateYourCocoapods/" data-toggle="tooltip" data-placement="top"
                     title="Create Your Cocoapods">Next Post&rarr;</a>
              </li>
              
          </ul>
        
  <br>
  
  <!-- disqus start -->
  <div class="comment">
    <div id="disqus_thread"  class="disqus-thread"></div>
      <script>
      var disqus_shortname = 'hexo-a-rsnippet';
      
      var disqus_url = 'http://yoursite.com/WhatDidiOSDoBeforeMain/';
      
      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  <!-- disqus end -->
  

  
  </div>


        
  <div class="hidden-xs col-sm-3 toc-col">
    <div class="toc-wrap">
        Table of Contents
        
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#What-did-iOS-do-before-main"><span class="toc-number">1.</span> <span class="toc-text">What did iOS do before main</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-number">1.1.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load"><span class="toc-number">1.2.</span> <span class="toc-text">+ load</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initialize"><span class="toc-number">1.3.</span> <span class="toc-text">+ initialize</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dyld"><span class="toc-number">1.4.</span> <span class="toc-text">dyld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态链接库，需设置-Runpath"><span class="toc-number">1.5.</span> <span class="toc-text">动态链接库，需设置 Runpath</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#executable-path，指向应用安装位置。"><span class="toc-number">1.5.1.</span> <span class="toc-text">@executable_path，指向应用安装位置。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loader-path，指向-Binary（Apps，Plugins-Framworks-Dylibs-的位置。"><span class="toc-number">1.5.2.</span> <span class="toc-text">@loader_path，指向 Binary（Apps，Plugins, Framworks, Dylibs) 的位置。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rpath"><span class="toc-number">1.5.3.</span> <span class="toc-text">@rpath</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">1.6.</span> <span class="toc-text">References</span></a></li></ol></li></ol>
        
    </div>
  </div>


      </div>
  </div>
</article>

<!-- Footer -->
<!-- footer.ejs -->
<footer>
    <div class="text-center">
      <ul class="list-inline">
          
          
          

          

          

          
              <li>
                  <a target="_blank"  href="https://github.com/chudanqin">
                      <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                      </span>
                  </a>
              </li>
          

          

          

      </ul>
     <div class="text-muted copyright">
            &copy;
            
            2017 - 2018
            
            
              <i class="fa fa-heart"></i>
            
            Unnamed
        <br>
          
              Powered by <a target="_blank" href="https://hexo.io">Hexo</a>
          
          
            |
          
          
              Theme - <a href="https://github.com/huyingjie/hexo-theme-A-RSnippet" target="_blank">A-RSnippet</a> v0.1.0
          
          
      </div>
    </div>
</footer>

<!-- Custom Theme JavaScript -->
<script src="/js/main.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>



</body>

</html>
